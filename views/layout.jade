doctype html

html

    head
        title Intelligent Rickshaw BCN: #{title}
        meta( charset="utf-8" )
        meta( http-equiv="X-UA-Compatible", content="IE-edge")
        meta( name="viewport", content="width=device-width, initial-scale=1.0")
        link(rel='stylesheet', href='/stylesheets/bootstrap.css')
        link(rel='stylesheet', href='/stylesheets/style.css')
        script(src='//code.jquery.com/jquery-1.11.0.min.js')
        script(src='/socket.io/socket.io.js')
        if user
            script(src='/javascripts/chat.js')
        script.
        
            // script in this position will run everytime the page is loaded/refreshed
            
            // declare variables and obtain those passed in
            var participants = !{JSON.stringify(participants)};
            var members = !{JSON.stringify(members)};
            var index = 0;
            var photoSRC = 'images/noimage.png';
            var user = !{JSON.stringify(user)};
            
            
            function startTimeAndPostLocation() {
                startTime();
                getLocation();
                
            
            }
            
            function startTime(){
                var today = new Date();
                var h = today.getHours();
                var m = today.getMinutes();
                var s = today.getSeconds();
                m = checkTime(m);
                s = checkTime(s);
                document.getElementById('clock').innerHTML = h + ":" + m + ":" + s;
                var t = setTimeout(startTime, 500);
            }
            
            function getLocation() {
                
                console.log("fetching location...");
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition, showError);
                } 
                else { 
                    x.innerHTML = "Geolocation is not supported by this browser.";
                }
            }

            function showPosition(position) {
                var x = document.getElementById("lat/lng");
                x.innerHTML = "Latitude: " + position.coords.latitude + 
                " Longitude: " + position.coords.longitude;
                if(!user){
                    $.post("/allpositions", {
                            id: "unknown",
                            position: position
                        }, function(response){
                            console.log(response);
                        
                            //- alert("Response: " + response);
                        }
                    );
                }
                else{
                    $.ajax({
                        url:  '/coords',
                        type: 'POST',
                        contentType: 'application/json',
                        dataType: 'json',
                        data: JSON.stringify({lat: position.coords.latitude, lng: position.coords.longitude, id: user.id})
                    });
                    console.log('Member Coords POSTed');
                }
            }

            function refreshApprovals(){
                $.get("/members/refreshApprovals", function(lastestApprovals){
                    console.log("updated list of Approvals received");
                    // do something here with the latest Approvals
                });
            
            
            }
            
            
            function showError(error) {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        x.innerHTML = "User denied the request for Geolocation."
                        break;
                    case error.POSITION_UNAVAILABLE:
                        x.innerHTML = "Location information is unavailable."
                        break;
                    case error.TIMEOUT:
                        x.innerHTML = "The request to get user location timed out."    
                        break;
                    case error.UNKNOWN_ERROR:
                        x.innerHTML = "An unknown error occurred."
                        break;
                }
            }
            
            function checkTime(i) {
                if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
                return i;
            }

    body(onload="startTimeAndPostLocation()")
        .container
            nav.navbar.navbar-default.navbar-fixed-top
                .div
                    .navbar-header
                        button.navbar-toggle.collapsed(type="button", data-toggle="collapse", data-target="#navbar", aria-expanded="false", aria-controls="navbar")
                            span.sr-only Toggle Navigation
                            span.icon-bar
                            span.icon-bar
                            span.icon-bar
                        a.navbar-left(href='/')
                            img(id="logo" src="/images/InteligentBCNlogo.png")
                        //- a.navbar-brand(href="/") Intelligent Rickshaw BCN
                    #navbar.collapse.navbar-collapse
                        ul.nav.navbar-nav
                            li(class=(title === "Home" ? "active" : ""))
                                a(href="/") Home
                            li(class=(title === "Rickshaws" ? "active" : ""))
                                a(href="/rickshaws") Rickshaws
                            li(class=(title === "Tours" ? "active" : ""))
                                a(href="/tours") Tours
                            li(class=(title === "Bookings" ? "active" : ""))
                                a(href="/bookings") Bookings
                            li(class=(title === "About" ? "active" : ""))
                                a(href="/about") About Us
                            li(class=(title === "Contact" ? "active" : ""))
                                a(href="/contact") Contact Us
                            if !user
                                li(class=(title === "Register" ? "active" : ""))
                                    a(href="/register") Register
                                li(class=(title === "Login" ? "active" : ""))
                                    a(href="/login") Log In
                            if user
                                li(class=(title === "Members" ? "active" : ""))
                                    a(href="/members") Members
                                li
                                    a(href="/members/logout") Log Out
            
            
            //- 
                if messages
                    != messages()
                div
                if participants
                    p There are #{participants.length} participants
                    if participants
                        each participant, i in participants
                            li.alert.alert-danger #{participant.id} , #{participant.username}
                                
                if !user
                    p You are NOT logged in
                    
                if user
                    p UserID: #{user.id} Name: #{user.name} #{user.surname} Username: #{user.username}  AccessLevel: #{user.access}
                
        
            block content 1
        
        footer
            p &copy; 2016 All Rights Reserved
            div(id="clock")
            button(onclick="getLocation()") Get Location
            p(id="lat/lng")
            
        script( src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" )
        script( src="/javascripts/bootstrap.js" )
        script ( src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYoKrfsjvAU7lUHHVPp_vXxrpy_2bJkNw&callback=initMap" )

